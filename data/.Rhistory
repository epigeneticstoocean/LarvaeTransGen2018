library(tidyverse)
library(plyr)
library(sciplot)
library(reshape2)
library(lme4)
library(lmerTest)
library(blme)
library(grid)
library(data.table)
library(gridExtra)
library(lattice)
#library(optimx)
library(car)
library(Hmisc)
library(corrplot)
#make a skewness function
skewness<- function (x){
result<-sum(((x-mean(x))/sd(x))^3)
return(result)
}
#setwd("~/Repos/LarvaeTransGen2018")
setwd("~/R/GitHub/LarvaeTransGen2018/data") #Elise's working directory
#upload all of the data tables for the larvae experiment
Larvae_Morphology <- read.csv("../data/Larvae_Morphology.csv") #contains data from CellProfiler from the larvae outlines
Barcode_Jar <- read.csv("../data/Barcode_Jar.csv") #contains data on CrossID, seatable, and whether or not larvae were present
Block_ID <- read.csv("../data/Block_ID.csv") #contains data on the block
Cross<- read.csv("../data/Cross.csv") #contains data on the female and male IDs for the cross and whether the cross was for QG or Meth
Fert_QG<- read.csv("../data/Fert_QG.csv") #contains data on fertilization counts, the JarIDs for the crosses
Header_WC<- read.csv("../data/Header_WC.csv") #contains data on the header tanks used to fill the jars
Larvae_Calcification <- read.csv("../data/Larvae_Calcification.csv") #contains data on filter weights and counts
Larvae_Counts <- read.csv("../data/Larvae_Counts.csv") #contains data on sedgewick rafter larvae counts
Larvae_WC <- read.csv("../data/Larvae_WC.csv") #contains data on larvae jar water chemistry
Parent_ID <- read.csv("../data/Parent_ID.csv") #contains data on the adults at the time of shucking. Includes Parent ID assignments
Larvae_Cilia<- read.csv("../data/Larvae_Cilia.csv") #contains data on cilia extrusion of the larvae photographed for morphology
Egg_Morphology<- read.csv("../data/Egg_Morphology.csv") #contains data on egg sizes from CellProfiler
Adult_Sample<- read.csv("../data/Adult_Sample.csv") #contains data on adult oysters at the time of collection
Storage_pH_Checks<- read.csv("../data/Storage_pH_Checks.csv") #contains data on the storage solution pH
WC_Standard<- read.csv("../data/WC_Standard.csv") #contains data on the standars used for water chemistry
# join data into dataframes for analysis and visualization
#First dataframe will be for examining eggs and adults; one value for each adult
ParentInfo<- merge(x=Parent_ID, y=Adult_Sample, by="AdultID", all.x=TRUE, all.y=TRUE)
#get average egg size for each female
MedianEgg<- ddply(Egg_Morphology, .(EggFemaleID), numcolwise(median, na.rm=T)) #get median egg size
FemAdults<- merge(x=ParentInfo, y= MedianEgg, by.x="ParentBlockID", by.y= "EggFemaleID", all.y=TRUE)
#will have to add tank water chemistry data to this dataframe when it is available
#make ParentTrt a factor
FemAdults$ParentTrt<- as.factor(FemAdults$ParentTrt)
#Second dataframe will be for examining egg morphology for all eggs traced; multiple values for each adult
Eggs<- merge(x=Egg_Morphology, y=ParentInfo, by.x="EggFemaleID", by.y="ParentBlockID", all.x=TRUE)
#will have to add tank water chemistry data to this dataframe when it is available
#make ParentTrt a factor
Eggs$ParentTrt<- as.factor(Eggs$ParentTrt)
#Third dataframe will be for one line per traced larva, includes all the data for that jar, including average egg size for that jar
#Eggs dataframe has all of the info that we need for the
Larvae<-merge(x=Larvae_Morphology, y=Barcode_Jar, by="JarID", all.x=TRUE)
#use gather function in tidyr to make the Fert_QG Jar ID columns in long form vs. wide form
Fert_QG_long <- Fert_QG %>% tidyr::gather(Key, JarID, JarID1:JarID6)
#use the gathered data frame to merge with Larvae
Larvae<-merge(x=Larvae, y=Fert_QG_long, by.x= c("JarID", "CrossID"), by.y=c("JarID", "CrossID"), all.x=TRUE) #did the join by two columns so CrossID column wasn't duplicated
Larvae<- merge(x=Larvae, y=Cross, by="CrossID", all.x=TRUE)
Larvae<- merge(x=Larvae, y=FemAdults, by.x= "FemaleID", by.y="ParentBlockID", all.x=TRUE)
Larvae<- merge(x=Larvae, y=Larvae_WC, by= "JarID", all.x=TRUE)
Larvae$JarSeatable<- as.factor(Larvae$JarSeatable)#make seatable a factor
#Fourth dataframe will be one line per Jar, includes all data for the jar, including the average larvae size per jar and cilia
LarvByJar<-merge(x=Larvae_Calcification, y=Larvae_Cilia, by="JarID", all.x=TRUE, all.y=TRUE)
LarvByJar<- merge(x=LarvByJar, y=Barcode_Jar, by="JarID", all.x=TRUE)
LarvByJar<- merge(x=LarvByJar, y=Fert_QG_long, by.x=c("JarID", "CrossID"), by.y=c("JarID","CrossID"), all.x=TRUE)
LarvByJar<- merge(x=LarvByJar, y=Cross, by="CrossID", all.x=TRUE)
LarvByJar<- merge(x=LarvByJar, y=FemAdults, by.x="FemaleID", by.y="ParentBlockID", all.x=TRUE)
#get the means for larvae morphology and add to LarvByJar
MeanLarvMorph<- ddply(Larvae_Morphology, .(JarID), numcolwise(mean, na.rm=T))
SELarvMorph<- ddply(Larvae_Morphology, .(JarID), numcolwise(se, na.rm=T)) #get standard error of larvae size
MeanLarvMorph<- full_join(MeanLarvMorph,SELarvMorph, by=c("JarID", "JarID"),suffix=c("","SE")) #join the mean and se larvae data
LarvByJar<- merge(x=LarvByJar, y=MeanLarvMorph, by="JarID", all.x=TRUE)
LarvByJar<- merge(x=LarvByJar, y=Larvae_WC, by="JarID", all.x=TRUE)
ggplot(Eggs, aes(x=EggDiameteruM, color=ParentTrt))+
geom_histogram(alpha=0.5, position="identity") +
facet_grid(~BlockID)
#we can see that the egg data are slightly left skewed
eggmeans<- aggregate(EggDiameteruM~ParentTrt, data=Eggs, FUN=mean) #400 = 61.7; 2800= 62.4
eggmedians<- aggregate(EggDiameteruM~ParentTrt, data=Eggs, FUN=median)#400 = 62.4; 2800= 62.5
#is it worth using the median for egg size instead of the mean? they look very similar; I am going to use the median to start because skewness seems large
B1<- subset(Larvae, BlockID.x =="B1")
ggplot(B1,
aes(fill = ParentTrt, y = LarvaeDiamum, x = EggDiameteruM)) +
geom_point(aes( shape=JarTrt, colour=ParentTrt)) +
ggtitle("Larvae diameter by egg diameter")+
ylab("Larvae Diameter (um)")+
facet_grid(~JarTrt)+
theme_classic()
#start with a simple linear model
larv1<- lm(LarvaeDiamum~ParentTrt*JarTrt+EggDiameteruM, data=B1)
par(mfcol=c(2,2))
plot(larv1) #does not seem to be normally distributed
par(mfcol=c(1,1))
#plot the residuals of lm1 vs. Female and Male ID
plot(resid(larv1)~B1$FemaleID)
plot(resid(larv1)~B1$MaleID)
#does not seem to be a problem
#look for autocorrelation
matB1<- data.matrix(B1,rownames.force=NA)#make a matrix from the dataframe
#now create a correlation matrix
larv1corr<- cor(matB1, method=c("pearson"))
corrB1<- rcorr(matB1, type= c("pearson"))
#corrB1 #look at the correlation matrix that was produced
corrB1<- flattenCorrMatrix(corrB1$r,corrB1$P)
#try to visualize the correlation matrix
corrB1.coeff<- corrB1$r
corrB1.p<- corrB1$P
plot(resid(B1_2t)~B1$BlockID.x) #does not seem to need to be accounted for
B1_3 <- lmer(LarvaeDiamum~ParentTrt*JarTrt + (1|FemaleID)+(1|MaleID) + (1|JarID) + (1|TimeFilter), data=B1)
plot(resid(B1_3)~B1$ParentTrt)
plot(resid(B1_3)~B1$JarTrt)
plot(B1_3)# seems to meet assumption of homoscedasticity but check with Levene's test:
leveneTest(resid(B1_3)~B1$ParentTrt*B1$JarTrt, center=mean) #p<0.05 still does not meet assumption of homoscedasticity
qqnorm(resid(B1_3))
qqline(resid(B1_3)) #still does not meet assumption of normality
B1_3t <- lmer(log(LarvaeDiamum)~ParentTrt*JarTrt + (1|FemaleID)+(1|MaleID) + (1|JarID) + (1|TimeFilter), data=B1)
plot(resid(B1_3t)~B1$ParentTrt)
plot(resid(B1_3t)~B1$JarTrt)
plot(B1_3t)# seems to meet assumption of homoscedasticity but check with Levene's test:
leveneTest(resid(B1_3t)~B1$ParentTrt*B1$JarTrt, center=mean) #p<0.05 still does not meet assumption of homoscedasticity
qqnorm(resid(B1_3t))
qqline(resid(B1_3t)) #still doesn't meet assumption of normality
View(Larvae)
Larvae$JarpH
B1tlm <- lmer(log(LarvaeDiamum)~ParentTrt*JarpH + (1|FemaleID)+(1|MaleID) + (1|JarID) + (1|TimeFilter), data=B1)
plot(resid(B1tlm)~B1$ParentTrt)
plot(resid(B1tlm)~B1$JarTrt)
plot(B1tlm)# seems to meet assumption of homoscedasticity but check with Levene's test:
leveneTest(resid(B1tlm)~B1$ParentTrt*B1$JarTrt, center=mean) #p<0.05 still does not meet assumption of homoscedasticity
qqnorm(resid(B1tlm))
qqline(resid(B1tlm)) #still doesn't meet assumption of normality
plot(B1$JarpH)
plot(B1$JarpH~JarTrt)
plot(B1$JarpH~B1$JarTrt)
